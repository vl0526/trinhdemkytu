<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProType Char Console</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.freepik.com/512/8361/8361102.png?ga=GA1.1.1777325421.1747727308">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --font-primary: 'Inter', sans-serif;
            --font-monospace: 'Roboto Mono', monospace;
            --ease-out-quad: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --ease-in-out-cubic: cubic-bezier(0.645, 0.045, 0.355, 1);
            --transition-fast: 0.2s var(--ease-out-quad);
            --transition-med: 0.4s var(--ease-out-quad);
            --transition-slow: 0.6s var(--ease-out-quad);
        }

        body.light-theme {
            --bg-primary: #f7f8fc;
            --bg-secondary: #fff;
            --bg-tertiary: #eef0f6;
            --text-primary: #2c3e50;
            --text-secondary: #576574;
            --text-tertiary: #8395a7;
            --accent-primary: #3498db;
            --accent-secondary: #2ecc71;
            --accent-error: #e74c3c;
            --accent-warning: #f39c12;
            --border-color: #dfe4ea;
            --shadow-color: rgba(44, 62, 80, .1);
            --accent-primary-rgb: 52, 152, 219;
        }

        body.dark-theme {
            --bg-primary: #1e272e;
            --bg-secondary: #2c3a47;
            --bg-tertiary: #34404d;
            --text-primary: #eceff1;
            --text-secondary: #b0bec5;
            --text-tertiary: #78909c;
            --accent-primary: #54a0ff;
            --accent-secondary: #2ed573;
            --accent-error: #ff4757;
            --accent-warning: #ffa502;
            --border-color: #4a5568;
            --shadow-color: rgba(0, 0, 0, .25);
            --accent-primary-rgb: 84, 160, 255;
        }

        *,
        ::after,
        ::before {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-primary);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 25px;
            transition: background-color var(--transition-med), color var(--transition-med);
            overflow-x: hidden;
        }

        .theme-switcher {
            position: fixed;
            top: 25px;
            right: 25px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 12px var(--shadow-color);
            z-index: 1001;
            transition: transform .15s ease-in-out, background-color var(--transition-med), border-color var(--transition-med);
        }

        .theme-switcher:hover {
            transform: scale(1.1);
        }

        .theme-switcher svg {
            width: 24px;
            height: 24px;
            fill: var(--text-secondary);
            transition: fill var(--transition-med);
        }

        .main-container {
            background-color: var(--bg-secondary);
            padding: 35px 40px;
            border-radius: 16px;
            box-shadow: 0 10px 30px -5px var(--shadow-color);
            width: 100%;
            max-width: 850px;
            text-align: center;
            animation: containerEntrance .8s var(--ease-in-out-cubic) forwards;
            transition: background-color var(--transition-med), box-shadow var(--transition-med);
        }

        @keyframes containerEntrance {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(.95);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .app-header h1 {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 25px;
            animation: headerSlideIn .7s var(--ease-out-quad) .2s forwards;
            opacity: 0;
            transform: translateY(-15px);
            letter-spacing: -.5px;
        }

        @keyframes headerSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-area {
            position: relative;
            margin-bottom: 25px;
        }

        textarea#charInput {
            width: 100%;
            min-height: 280px;
            max-height: 45vh;
            padding: 18px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: var(--font-monospace);
            font-size: 1em;
            line-height: 1.65;
            resize: vertical;
            outline: none;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background-color var(--transition-med), color var(--transition-med);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, .03);
        }

        textarea#charInput:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(var(--accent-primary-rgb), .3), inset 0 2px 4px rgba(0, 0, 0, .03);
        }

        .stats-dashboard {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 0;
            margin-bottom: 20px;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            transition: border-color var(--transition-med);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
            position: relative;
        }

        .stat-label {
            font-size: .8em;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 600;
            letter-spacing: .5px;
            transition: color var(--transition-med);
        }

        .stat-value {
            font-family: var(--font-monospace);
            font-size: 1.75em;
            font-weight: 500;
            color: var(--text-primary);
            transition: color var(--transition-med);
            min-height: 1.2em;
        }

        .stat-value.animated-value span {
            display: inline-block;
            animation: valueUpdateAnim .3s var(--ease-out-quad);
        }

        @keyframes valueUpdateAnim {
            from {
                opacity: .5;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .progress-indicator {
            flex-grow: 1;
            height: 8px;
            background-color: var(--bg-tertiary);
            border-radius: 4px;
            margin: 0 25px;
            overflow: hidden;
            transition: background-color var(--transition-med);
        }

        .progress-fill {
            height: 100%;
            width: 0;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary));
            transition: width .3s var(--ease-out-quad), background var(--transition-med);
        }

        .status-message {
            font-size: .9em;
            min-height: 1.5em;
            margin-top: 8px;
            transition: opacity var(--transition-med), color var(--transition-med);
            opacity: 0;
            font-weight: 500;
        }

        .status-message.visible {
            opacity: 1;
        }

        .status-message.warning {
            color: var(--accent-warning);
        }

        .status-message.error {
            color: var(--accent-error);
        }

        .app-footer {
            margin-top: 30px;
            font-size: .85em;
            color: var(--text-tertiary);
            opacity: .8;
            transition: color var(--transition-med);
        }

        .input-alert {
            animation: inputErrorShake .4s linear;
        }

        @keyframes inputErrorShake {
            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-4px);
            }

            75% {
                transform: translateX(4px);
            }
        }

        /* New styles for buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        .action-button {
            background-color: var(--accent-primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 10px rgba(var(--accent-primary-rgb), 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(var(--accent-primary-rgb), 0.3);
        }

        .action-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(var(--accent-primary-rgb), 0.2);
        }

        .action-button i {
            font-size: 1.1em;
        }

        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1002; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            position: relative;
            animation: modalOpen 0.3s ease-out;
            color: var(--text-primary);
        }

        @keyframes modalOpen {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .close-button {
            color: var(--text-secondary);
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--accent-error);
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: var(--accent-primary);
            font-size: 1.8em;
            font-weight: 700;
        }

        .modal-content pre {
            background-color: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            max-height: 60vh;
            overflow: auto;
            font-family: var(--font-monospace);
            font-size: 0.95em;
            line-height: 1.5;
            text-align: left;
            white-space: pre-wrap; /* Ensures text wraps */
            word-wrap: break-word; /* Breaks long words */
            border: 1px solid var(--border-color);
        }

        .modal-content .link-display {
            background-color: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            font-family: var(--font-monospace);
            font-size: 0.95em;
            text-align: left;
            word-break: break-all;
            margin-top: 20px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-content .link-display input[type="text"] {
            flex-grow: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-family: var(--font-monospace);
            cursor: text;
        }

        .modal-content .link-display button {
            background-color: var(--accent-secondary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .modal-content .link-display button:hover {
            background-color: #28a745;
        }

        /* Loading indicator */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1003;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5em;
            flex-direction: column;
            gap: 15px;
        }

        .loader {
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--accent-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-container {
                padding: 25px 20px;
            }
            .app-header h1 {
                font-size: 1.8em;
            }
            .stats-dashboard {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            .progress-indicator {
                margin: 0;
                width: 100%;
            }
            .action-buttons {
                flex-direction: column;
                gap: 10px;
            }
            .action-button {
                width: 100%;
            }
            .theme-switcher {
                top: 15px;
                right: 15px;
                width: 40px;
                height: 40px;
            }
            .theme-switcher svg {
                width: 20px;
                height: 20px;
            }
        }
    </style>
</head>
<body class="light-theme">
    <button class="theme-switcher" id="themeSwitcher" aria-label="Switch to dark mode">
        <svg id="themeIconSun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM12 9c1.65 0 3 1.35 3 3s-1.35 3-3 3-3-1.35-3-3 1.35-3 3-3zm0-7c.55 0 1 .45 1 1v2c0 .55-.45 1-1 1s-1-.45-1-1V3c0-.55.45-1 1-1zm0 18c.55 0 1 .45 1 1v2c0 .55-.45 1-1 1s-1-.45-1-1v-2c0-.55.45-1 1-1zm-7.07-3.07c.39.39 1.02.39 1.41 0l1.41-1.41c.39-.39.39-1.02 0-1.41a.996.996 0 00-1.41 0l-1.41 1.41c-.39.39-.39 1.03 0 1.41zm11.31-11.31c.39.39 1.02.39 1.41 0l1.41-1.41c.39-.39.39-1.02 0-1.41a.996.996 0 00-1.41 0l-1.41 1.41c-.39.39-.39 1.03 0 1.41zM4 12c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1s.45-1 1-1h2c.55 0 1 .45 1 1zm18 0c0 .55-.45 1-1 1h-2c-.55 0-1-.45-1-1s.45-1 1-1h2c.55 0 1 .45 1 1zm-6.34 6.34c.39.39 1.02.39 1.41 0l1.41-1.41c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41zM6.22 6.22c.39.39 1.02.39 1.41 0l1.41-1.41c.39-.39.39-1.02 0-1.41A.996.996 0 007.63 3.39L6.22 4.8c-.38.39-.38 1.03.00 1.42z"/></svg>
        <svg id="themeIconMoon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display:none"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c3.31 0 6-2.69 6-6 0-4.97-4.03-9-9-9zm-1 14.5c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
    </button>
    <div class="main-container">
        <header class="app-header">
            <h1>ProType Character Console</h1>
        </header>
        <main>
            <div class="input-area">
                <textarea id="charInput" placeholder="Type your masterpiece here..." spellcheck="false"></textarea>
            </div>
            <div class="stats-dashboard">
                <div class="stat-item">
                    <span class="stat-label">Characters</span>
                    <span id="countDisplay" class="stat-value">0</span>
                </div>
                <div class="progress-indicator">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Remaining</span>
                    <span id="remainingDisplay" class="stat-value">1M</span>
                </div>
            </div>
            <p id="statusMessage" class="status-message"></p>

            <div class="action-buttons">
                <input type="file" id="fileInput" accept=".txt, .md, .html, .css, .js, .json, .xml, .csv" style="display: none;">
                <button class="action-button" id="uploadButton">
                    <i class="fas fa-upload"></i> Upload File
                </button>
                <button class="action-button" id="downloadButton">
                    <i class="fas fa-download"></i> Download File
                </button>
                <button class="action-button" id="viewRawButton">
                    <i class="fas fa-code"></i> View Raw <i class="fas fa-arrow-right"></i>
                </button>
                <button class="action-button" id="saveLinkButton">
                    <i class="fas fa-share-alt"></i> Save to Link
                </button>
            </div>
        </main>
        <footer class="app-footer">
            <p>Â© 2024 PrecisionSoft. All rights reserved.</p>
            <p>User ID: <span id="userIdDisplay">Loading...</span></p>
        </footer>
    </div>

    <div id="rawViewModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeRawViewModal">&times;</span>
            <h2>Raw Content View</h2>
            <pre id="rawContentDisplay"></pre>
        </div>
    </div>

    <div id="shareLinkModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeShareLinkModal">&times;</span>
            <h2>Shareable Link</h2>
            <p>Copy the link below to share your content:</p>
            <div class="link-display">
                <input type="text" id="shareLinkInput" readonly>
                <button id="copyLinkButton"><i class="fas fa-copy"></i> Copy</button>
            </div>
            <p style="margin-top: 15px; font-size: 0.9em; color: var(--text-secondary);">This link will display your content in a raw format.</p>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loader"></div>
        <p id="loadingMessage">Loading...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous

        // Access global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase and authenticate
        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing or empty. Cannot initialize Firebase.");
                    document.getElementById('loadingMessage').textContent = "Error: Firebase not configured.";
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in using custom token if available, otherwise anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for auth state changes to get the user ID
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = userId;
                        console.log("Firebase authenticated. User ID:", userId);
                    } else {
                        // If user logs out or token expires, sign in anonymously again
                        signInAnonymously(auth).then(anonUser => {
                            userId = anonUser.user.uid;
                            document.getElementById('userIdDisplay').textContent = userId + " (Anonymous)";
                            console.log("Firebase signed in anonymously. User ID:", userId);
                        }).catch(error => {
                            console.error("Error signing in anonymously:", error);
                            document.getElementById('userIdDisplay').textContent = "Auth Error";
                        });
                    }
                    document.getElementById('loadingOverlay').style.display = 'none'; // Hide loading after auth
                    checkUrlForContent(); // Check URL for content after auth is ready
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('loadingMessage').textContent = `Error: ${error.message}`;
            }
        };

        // Function to show custom modal messages
        function showMessageModal(title, message, type = 'info') {
            const modal = document.getElementById('rawViewModal'); // Reusing raw view modal for simplicity
            const modalTitle = modal.querySelector('h2');
            const modalContent = modal.querySelector('pre');
            const closeButton = document.getElementById('closeRawViewModal');

            modalTitle.textContent = title;
            modalContent.textContent = message;
            modalContent.style.color = type === 'error' ? 'var(--accent-error)' : 'var(--text-primary)';
            modalContent.style.whiteSpace = 'pre-wrap'; // Ensure wrapping for messages
            modalContent.style.wordWrap = 'break-word';

            modal.style.display = 'flex';
            closeButton.onclick = () => {
                modal.style.display = 'none';
            };
        }

        // Function to show loading overlay
        function showLoading(message = 'Loading...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // Function to hide loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Function to generate a random ID
        function generateRandomId(length = 10) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0987654321';
            let result = '';
            const charactersLength = characters.length;
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }

        // Function to save content to Firestore
        async function saveContentToFirestore(content) {
            if (!db || !userId) {
                showMessageModal("Error", "Firebase not initialized or user not authenticated.", "error");
                return null;
            }
            showLoading('Saving content...');
            try {
                const docId = generateRandomId(12); // Generate a random ID for the document
                const contentRef = doc(collection(db, `artifacts/${appId}/public/data/texts`), docId);
                await setDoc(contentRef, {
                    content: content,
                    timestamp: new Date().toISOString(),
                    userId: userId
                });
                hideLoading();
                return docId;
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessageModal("Error", `Failed to save content: ${e.message}`, "error");
                hideLoading();
                return null;
            }
        }

        // Function to load content from Firestore
        async function loadContentFromFirestore(docId) {
            if (!db) {
                showMessageModal("Error", "Firebase not initialized.", "error");
                return null;
            }
            showLoading('Loading content...');
            try {
                const contentRef = doc(db, `artifacts/${appId}/public/data/texts`, docId);
                const docSnap = await getDoc(contentRef);

                if (docSnap.exists()) {
                    hideLoading();
                    return docSnap.data().content;
                } else {
                    showMessageModal("Not Found", "No content found for this ID.", "warning");
                    hideLoading();
                    return null;
                }
            } catch (e) {
                console.error("Error getting document: ", e);
                showMessageModal("Error", `Failed to load content: ${e.message}`, "error");
                hideLoading();
                return null;
            }
        }

        // Check URL parameters for content on page load
        async function checkUrlForContent() {
            const urlParams = new URLSearchParams(window.location.search);
            const contentId = urlParams.get('id');
            const viewType = urlParams.get('view');

            if (contentId && viewType === 'raw') {
                const content = await loadContentFromFirestore(contentId);
                if (content) {
                    document.getElementById('charInput').value = content;
                    updateCharacterStats();
                    // Automatically show raw view if loaded from URL
                    document.getElementById('rawContentDisplay').textContent = content;
                    document.getElementById('rawViewModal').style.display = 'flex';
                }
            }
        }

        // Initialize Firebase when the DOM is ready
        document.addEventListener('DOMContentLoaded', initFirebase);

        // Main application logic (original and new features)
        document.addEventListener('DOMContentLoaded', function() {
            const charInput = document.getElementById('charInput');
            const countDisplay = document.getElementById('countDisplay');
            const remainingDisplay = document.getElementById('remainingDisplay');
            const progressFill = document.getElementById('progressFill');
            const statusMessage = document.getElementById('statusMessage');
            const themeSwitcher = document.getElementById('themeSwitcher');
            const themeIconSun = document.getElementById('themeIconSun');
            const themeIconMoon = document.getElementById('themeIconMoon');
            const body = document.body;

            // New elements
            const fileInput = document.getElementById('fileInput');
            const uploadButton = document.getElementById('uploadButton');
            const downloadButton = document.getElementById('downloadButton');
            const viewRawButton = document.getElementById('viewRawButton');
            const saveLinkButton = document.getElementById('saveLinkButton');
            const rawViewModal = document.getElementById('rawViewModal');
            const closeRawViewModal = document.getElementById('closeRawViewModal');
            const rawContentDisplay = document.getElementById('rawContentDisplay');
            const shareLinkModal = document.getElementById('shareLinkModal');
            const closeShareLinkModal = document.getElementById('closeShareLinkModal');
            const shareLinkInput = document.getElementById('shareLinkInput');
            const copyLinkButton = document.getElementById('copyLinkButton');


            const MAX_CHARS = 1000000; // 1 Million characters
            const WARNING_THRESHOLD = 0.98; // 98% of max chars

            let currentCount = 0;
            let animationFrameRequested = false;

            // Helper to format numbers (e.g., 1000000 -> 1M)
            function formatNumber(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(num % 1000000 === 0 ? 0 : 1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(num % 1000 === 0 ? 0 : 1) + 'K';
                return num.toString();
            }

            // Function to update a stat value with animation
            function updateStatValue(element, newValue, animate = true) {
                if (element.textContent !== newValue) {
                    if (animate) {
                        element.innerHTML = `<span>${newValue}</span>`;
                        element.classList.add('animated-value');
                        setTimeout(() => element.classList.remove('animated-value'), 300); // Remove class after animation
                    } else {
                        element.textContent = newValue;
                    }
                }
            }

            // Main function to update character stats and UI
            function updateCharacterStats() {
                animationFrameRequested = false; // Reset flag

                let text = charInput.value;
                let newCount = text.length;

                // Truncate text if it exceeds max characters
                let truncated = false;
                if (newCount > MAX_CHARS) {
                    text = text.substring(0, MAX_CHARS);
                    charInput.value = text;
                    newCount = MAX_CHARS;
                    truncated = true;
                    if (!charInput.classList.contains('input-alert')) {
                        charInput.classList.add('input-alert');
                        setTimeout(() => charInput.classList.remove('input-alert'), 400);
                    }
                }

                const remaining = MAX_CHARS - newCount;
                const progressPercentage = (newCount / MAX_CHARS) * 100;

                // Update displays with animation
                updateStatValue(countDisplay, newCount.toLocaleString(), true);
                updateStatValue(remainingDisplay, formatNumber(remaining), true);

                progressFill.style.width = `${progressPercentage}%`;

                // Update status message
                statusMessage.classList.remove('visible', 'warning', 'error');
                if (truncated || newCount === MAX_CHARS) {
                    statusMessage.textContent = 'Character limit reached.';
                    statusMessage.classList.add('visible', 'error');
                } else if (newCount >= MAX_CHARS * WARNING_THRESHOLD) {
                    statusMessage.textContent = 'Approaching character limit.';
                    statusMessage.classList.add('visible', 'warning');
                } else if (newCount > 0) {
                    statusMessage.textContent = 'All systems nominal.';
                    statusMessage.classList.add('visible');
                } else {
                    statusMessage.textContent = 'Awaiting input sequence...';
                    statusMessage.classList.add('visible');
                }
            }

            // Request animation frame for smooth updates
            function requestUpdate() {
                if (!animationFrameRequested) {
                    animationFrameRequested = true;
                    requestAnimationFrame(updateCharacterStats);
                }
            }

            // Event listener for text input
            charInput.addEventListener('input', requestUpdate);
            charInput.addEventListener('propertychange', requestUpdate); // For IE compatibility
            charInput.addEventListener('cut', requestUpdate);
            charInput.addEventListener('paste', requestUpdate);

            // Theme switcher logic
            const accentPrimaryRgb = {
                'light': '52, 152, 219',
                'dark': '84, 160, 255'
            };

            function setTheme(theme) {
                body.classList.remove('light-theme', 'dark-theme');
                body.classList.add(theme + '-theme');
                if (theme === 'dark') {
                    themeIconSun.style.display = 'none';
                    themeIconMoon.style.display = 'block';
                    themeSwitcher.setAttribute('aria-label', 'Switch to light mode');
                    document.documentElement.style.setProperty('--accent-primary-rgb', accentPrimaryRgb.dark);
                } else {
                    themeIconMoon.style.display = 'none';
                    themeIconSun.style.display = 'block';
                    themeSwitcher.setAttribute('aria-label', 'Switch to dark mode');
                    document.documentElement.style.setProperty('--accent-primary-rgb', accentPrimaryRgb.light);
                }
                localStorage.setItem('protype-theme', theme);
            }

            themeSwitcher.addEventListener('click', function() {
                const currentTheme = body.classList.contains('light-theme') ? 'light' : 'dark';
                setTheme(currentTheme === 'light' ? 'dark' : 'light');
            });

            // Apply saved theme or system preference on load
            const savedTheme = localStorage.getItem('protype-theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            setTheme(savedTheme || (prefersDark ? 'dark' : 'light'));

            // Initial update of stats on page load
            updateCharacterStats();

            // --- New Features Implementation ---

            // 1. File Upload
            uploadButton.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                // Check for text-based file types
                const allowedTypes = [
                    'text/plain', 'text/markdown', 'text/html', 'text/css', 'application/javascript',
                    'application/json', 'application/xml', 'text/csv'
                ];
                if (!allowedTypes.includes(file.type) && !file.name.match(/\.(txt|md|html|css|js|json|xml|csv)$/i)) {
                    showMessageModal("Unsupported File Type", "Please upload a text-based file (e.g., .txt, .md, .js, .json, .html, .css, .csv, .xml).", "warning");
                    return;
                }

                showLoading('Reading file...');
                const reader = new FileReader();
                reader.onload = (e) => {
                    charInput.value = e.target.result;
                    requestUpdate(); // Update stats after loading content
                    hideLoading();
                };
                reader.onerror = (e) => {
                    console.error("Error reading file:", e);
                    showMessageModal("File Read Error", "Could not read the file. Please try again.", "error");
                    hideLoading();
                };
                reader.readAsText(file);
            });

            // 2. Download File
            downloadButton.addEventListener('click', () => {
                const content = charInput.value;
                if (!content) {
                    showMessageModal("No Content", "There is no content to download.", "warning");
                    return;
                }

                const filename = "protype_console_output.txt";
                const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href); // Clean up
            });

            // 3. View Raw
            viewRawButton.addEventListener('click', () => {
                const content = charInput.value;
                if (!content) {
                    showMessageModal("No Content", "There is no content to view in raw format.", "warning");
                    return;
                }
                rawContentDisplay.textContent = content;
                rawViewModal.style.display = 'flex';
            });

            closeRawViewModal.addEventListener('click', () => {
                rawViewModal.style.display = 'none';
            });

            // Close modal if clicked outside content
            rawViewModal.addEventListener('click', (event) => {
                if (event.target === rawViewModal) {
                    rawViewModal.style.display = 'none';
                }
            });

            // 4. Save to Link
            saveLinkButton.addEventListener('click', async () => {
                const content = charInput.value;
                if (!content) {
                    showMessageModal("No Content", "There is no content to save.", "warning");
                    return;
                }

                const docId = await saveContentToFirestore(content);
                if (docId) {
                    const shareableLink = `${window.location.origin}${window.location.pathname}?id=${docId}&view=raw`;
                    shareLinkInput.value = shareableLink;
                    shareLinkModal.style.display = 'flex';
                }
            });

            closeShareLinkModal.addEventListener('click', () => {
                shareLinkModal.style.display = 'none';
            });

            shareLinkModal.addEventListener('click', (event) => {
                if (event.target === shareLinkModal) {
                    shareLinkModal.style.display = 'none';
                }
            });

            copyLinkButton.addEventListener('click', () => {
                shareLinkInput.select();
                shareLinkInput.setSelectionRange(0, 99999); // For mobile devices
                try {
                    document.execCommand('copy');
                    copyLinkButton.textContent = 'Copied!';
                    setTimeout(() => {
                        copyLinkButton.innerHTML = '<i class="fas fa-copy"></i> Copy';
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    showMessageModal("Copy Error", "Failed to copy link. Please copy it manually.", "error");
                }
            });
        });
    </script>
</body>
</html>
